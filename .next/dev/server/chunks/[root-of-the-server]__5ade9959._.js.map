{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jarvis/OneDrive/%C3%81rea%20de%20Trabalho/front%201/frontend-ii/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\n// API routes não precisam de storageKey pois cada request HTTP é isolada\r\nexport async function createServerClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createSupabaseServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The `setAll` method was called from a Server Component.\r\n          // This can be ignored if you have middleware refreshing\r\n          // user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n\r\nexport { createServerClient as createClient }\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;;;AAGO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,8JAAO;IAEjC,OAAO,IAAA,mNAA0B,sUAAoF;QACnH,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF","debugId":null}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jarvis/OneDrive/%C3%81rea%20de%20Trabalho/front%201/frontend-ii/app/api/whatsapp/etiquetas/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"whatsapp_etiquetas\")\r\n      .select(\"*\")\r\n      .order(\"nome\", { ascending: true })\r\n\r\n    if (error) throw error\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      etiquetas: data || [],\r\n    })\r\n  } catch (error) {\r\n    console.error(\"Erro ao carregar etiquetas:\", error)\r\n    return NextResponse.json(\r\n      { success: false, message: \"Erro ao carregar etiquetas\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const cookieStore = await cookies()\r\n    const supabase = await createClient()\r\n    const body = await request.json()\r\n    const { nome, cor, descricao } = body\r\n\r\n    if (!nome || !cor) {\r\n      return NextResponse.json(\r\n        { success: false, message: \"Nome e cor são obrigatórios\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Pega o ID e nome do usuário autenticado\r\n    const userId = cookieStore.get(\"auth_user_id\")?.value\r\n    let userName = \"Sistema\"\r\n\r\n    if (userId) {\r\n      const { data: userProfile } = await supabase\r\n        .from(\"perfis\")\r\n        .select(\"nome\")\r\n        .eq(\"id\", userId)\r\n        .single()\r\n      if (userProfile) userName = userProfile.nome\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"whatsapp_etiquetas\")\r\n      .insert({\r\n        nome: nome.trim(),\r\n        cor: cor.trim(),\r\n        descricao: descricao?.trim() || null,\r\n        created_by_id: userId || null,\r\n        created_by_name: userName,\r\n      })\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw error\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      etiqueta: data,\r\n    })\r\n  } catch (error) {\r\n    console.error(\"Erro ao criar etiqueta:\", error)\r\n    return NextResponse.json(\r\n      { success: false, message: \"Erro ao criar etiqueta\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nexport async function PUT(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const body = await request.json()\r\n    const { id, nome, cor, descricao } = body\r\n\r\n    if (!id || !nome || !cor) {\r\n      return NextResponse.json(\r\n        { success: false, message: \"ID, nome e cor são obrigatórios\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"whatsapp_etiquetas\")\r\n      .update({\r\n        nome: nome.trim(),\r\n        cor: cor.trim(),\r\n        descricao: descricao?.trim() || null,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", id)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) throw error\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      etiqueta: data,\r\n    })\r\n  } catch (error) {\r\n    console.error(\"Erro ao atualizar etiqueta:\", error)\r\n    return NextResponse.json(\r\n      { success: false, message: \"Erro ao atualizar etiqueta\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nexport async function DELETE(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { searchParams } = new URL(request.url)\r\n    const id = searchParams.get(\"id\")\r\n\r\n    if (!id) {\r\n      return NextResponse.json(\r\n        { success: false, message: \"ID é obrigatório\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Primeiro, remove a etiqueta de todos os chats que a contêm\r\n    // Usa a função RPC para remover a etiqueta do array etiqueta_ids\r\n    const { error: removeError } = await supabase.rpc('remove_etiqueta_from_all_chats', { \r\n      p_etiqueta_id: id \r\n    })\r\n\r\n    // Se a função RPC não existir, faz a remoção manualmente\r\n    if (removeError && removeError.code === '42883') {\r\n      // Função não existe, faz update manual\r\n      // Busca todos os chats que têm essa etiqueta\r\n      const { data: chatsWithEtiqueta } = await supabase\r\n        .from('chats')\r\n        .select('id, etiqueta_ids')\r\n        .contains('etiqueta_ids', [id])\r\n\r\n      if (chatsWithEtiqueta && chatsWithEtiqueta.length > 0) {\r\n        // Remove a etiqueta de cada chat\r\n        for (const chat of chatsWithEtiqueta) {\r\n          const newEtiquetaIds = (chat.etiqueta_ids || []).filter((eid: string) => eid !== id)\r\n          await supabase\r\n            .from('chats')\r\n            .update({ etiqueta_ids: newEtiquetaIds })\r\n            .eq('id', chat.id)\r\n        }\r\n      }\r\n    } else if (removeError) {\r\n      console.error('Erro ao remover etiqueta dos chats:', removeError)\r\n      // Continua com a exclusão mesmo se houver erro na limpeza\r\n    }\r\n\r\n    // Agora exclui a etiqueta\r\n    const { error } = await supabase\r\n      .from(\"whatsapp_etiquetas\")\r\n      .delete()\r\n      .eq(\"id\", id)\r\n\r\n    if (error) throw error\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n    })\r\n  } catch (error) {\r\n    console.error(\"Erro ao deletar etiqueta:\", error)\r\n    return NextResponse.json(\r\n      { success: false, message: \"Erro ao deletar etiqueta\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}